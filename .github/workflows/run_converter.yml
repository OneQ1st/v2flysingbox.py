name: è‡ªåŠ¨ç”Ÿæˆ Sing-box è§„åˆ™

# å®šä¹‰è§¦å‘æ¡ä»¶ï¼ˆä¿®æ­£éƒ¨åˆ†ï¼šç¡®ä¿è‡³å°‘æœ‰ä¸€ä¸ªæœ‰æ•ˆçš„è§¦å‘å™¨ï¼‰
on:
  # å…è®¸æ‰‹åŠ¨è§¦å‘ï¼šæ‚¨å¯ä»¥é€šè¿‡ GitHub Actions é¡µé¢ç‚¹å‡»æŒ‰é’®è¿è¡Œå®ƒ
  workflow_dispatch:
  
  # åœ¨æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘ï¼ˆå¯é€‰ï¼Œå¦‚æœä¸éœ€è¦ï¼Œå¯ä»¥æ³¨é‡Šæ‰ï¼‰
  push:
    branches:
      - main
      
  # ä¹Ÿå¯ä»¥è®¾ç½®å®šæ—¶è§¦å‘ï¼Œä¾‹å¦‚æ¯å‘¨ä¸€å‡Œæ™¨ 0 ç‚¹ï¼ˆå¯é€‰ï¼Œå¦‚æœä¸éœ€è¦ï¼Œå¯ä»¥æ³¨é‡Šæ‰ï¼‰
  # schedule:
  #   - cron: '0 0 * * 1'
  
jobs:
  convert_and_commit:
    runs-on: ubuntu-latest
    # æˆäºˆ Actions å†™å…¥æƒé™ï¼Œä»¥ä¾¿æäº¤æ–‡ä»¶
    permissions:
      contents: write 

    steps:
      # 1. æ£€å‡ºæ‚¨çš„ä»“åº“
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          # å¯ç”¨ç¨€ç–æ£€å‡ºï¼Œåªæ£€å‡ºè„šæœ¬æ–‡ä»¶
          sparse-checkout: |
            v2fly2singbox.py
            
      # 2. è®¾ç½® Python ç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      # 3. å¿«é€Ÿæ‹‰å–è§„åˆ™æ–‡ä»¶ (ä½¿ç”¨æµ…å…‹éš†+ç¨€ç–æ£€å‡º)
      - name: Clone domain-list-community data (Sparse Checkout)
        run: |
          # å…‹éš† v2fly/domain-list-community ä»“åº“
          git clone --depth 1 --filter=blob:none --sparse \
            https://github.com/v2fly/domain-list-community.git
          
          # è¿›å…¥å…‹éš†çš„ä»“åº“ç›®å½•
          cd domain-list-community
          
          # æŒ‡å®šåªä¸‹è½½ data/ ç›®å½•çš„å†…å®¹
          git sparse-checkout set data/
          
          # [ä¿®æ­£ç‚¹] å°† main æ”¹ä¸º master
          git pull origin master

          # è¿”å›è„šæœ¬è¿è¡Œç›®å½•
          cd ..

      # 4. è¿è¡Œæ‚¨çš„ Python è„šæœ¬
      - name: Run Converter Script
        # è„šæœ¬å°†è¯»å– ./domain-list-community/data/google
        # å¹¶ç”Ÿæˆ ./google.json
        run: python v2fly2singbox.py
        
      # 5. æäº¤ç”Ÿæˆçš„ JSON æ–‡ä»¶
      - name: Commit generated file (google.json)
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'ğŸ¤– Auto: Update sing-box rule (google.json)'
          files: 'google.json'
